# Cilium Helm Values for k3d clusters
# This file configures Cilium CNI with advanced features enabled
# Note: Update cluster.name for each cluster deployment

# Cluster configuration
cluster:
  name: k3d-my-lab # Change to k3d-my-lab-2 when installing on remote cluster

# Operator configuration
operator:
  replicas: 1
  prometheus:
    enabled: true

# Networking configuration
routingMode: tunnel
tunnelProtocol: vxlan

# IPv6 support - Disabled for k3d (kernel modules not available)
# Enable this only if your cluster has IPv6 kernel modules loaded
ipv6:
  enabled: false

# Enable eBPF-based features for better performance
enableIPv4Masquerade: true
enableIPv6Masquerade: false # Disabled since IPv6 is not available
kubeProxyReplacement: true # Replace kube-proxy with eBPF-based implementation
bpf:
  masquerade: true
  hostLegacyRouting: false

# Bandwidth management
# Note: Disabled for k3d as procfs sysctl is not available
# Enable this on full Kubernetes clusters with proper kernel support
bandwidthManager:
  enabled: false
  bbr: false

# Network Policy Enforcement
policyEnforcementMode: default # "default", "always", or "never"

# Hubble - Network Observability Platform
hubble:
  enabled: true
  listenAddress: ":4244" # Hubble server listen address

  # Peer service configuration - must match listenAddress port
  peerService:
    targetPort: 4244

  # Hubble Relay - Provides API access to Hubble
  relay:
    enabled: true
    replicas: 1
    # Explicit peer target to avoid DNS resolution issues
    peerTarget: "hubble-peer.kube-system.svc.cluster.local:4244"

  # Hubble UI - Web interface for network visibility
  ui:
    enabled: true
    replicas: 1
    ingress:
      enabled: false # Set to true if you want ingress access

  # Hubble metrics for Prometheus
  metrics:
    enabled:
      - dns:query
      - drop
      - tcp
      - flow
      - icmp
      - http
    serviceMonitor:
      enabled: false # Set to true if using Prometheus Operator
    dashboards:
      enabled: false # Set to true if using Grafana

# Layer 7 (L7) Network Policy and Visibility
# Using envoy instead of deprecated proxy options (v1.16+)
envoy:
  enabled: true
  prometheus:
    enabled: true
    port: "9964"

# Enable monitoring and metrics
prometheus:
  enabled: true
  serviceMonitor:
    enabled: false # Set to true if using Prometheus Operator

# Additional security features
encryption:
  enabled: false # Enable WireGuard-based encryption (requires kernel support)
  type: wireguard

# DNS Proxy for visibility into DNS traffic - Configuration in dnsProxy section
# Note: dnsProxy settings are automatically enabled when Hubble is enabled

# Enable health checking
healthChecking: true
healthPort: 9879

# Performance tuning
# nodePort configuration (uses default settings)
# nodePort.bindProtection and nodePort.enableHealthCheck are enabled by default

# Enable Cilium agent debugging (disable in production)
debug:
  enabled: false

# Enable automatic direct node routes (for better performance in single cluster)
autoDirectNodeRoutes: false # Set to true if all nodes are in the same L2 network

# Service mesh features
loadBalancer:
  algorithm: random # Options: random, maglev
  mode: snat # SNAT mode for tunnel-based routing (DSR mode incompatible with vxlan)

# BGP support (advanced networking)
bgpControlPlane:
  enabled: false # Enable for advanced routing scenarios

# Enable identity allocation mode
identityAllocationMode: crd # Use CRDs for identity allocation

# Resource limits and requests (adjust based on your cluster size)
resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 100m
    memory: 128Mi
